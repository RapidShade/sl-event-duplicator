<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Duplicate Event Widget</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        body { font-family: sans-serif; padding: 1rem; text-align: center; color: #333; background-color: #f9f9f9; }
        #widget-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .hidden { display: none !important; }
        #loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        #period-selector-container { padding: 1rem; border: 1px solid #ccc; border-radius: 8px; background-color: white; }
        select, button { padding: 8px 12px; margin-top: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #4CAF50; color: white; cursor: pointer; }
        #status { margin-top: 1rem; font-weight: bold; }
        .status-success { color: green; }
        .status-error { color: red; }
        .status-info { color: #555; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div id="widget-container">
    <div id="initial-state">
        <h2>Duplicate Event Widget</h2>
        <p>Ready. Click the "Duplicate Event" button in any row in the Events table to begin.</p>
    </div>

    <div id="processing-state" class="hidden">
        <div id="loader"></div>
        <p id="processing-message">Working...</p>
    </div>

    <div id="period-selector-container" class="hidden">
        <label for="period-select">Select Target Period:</label><br>
        <select id="period-select"></select><br>
        <button id="confirm-duplication">Confirm & Duplicate</button>
        <button id="cancel-duplication">Cancel</button>
    </div>

    <div id="status"></div>
</div>

<script>
    // --- CONFIGURATION ---
    const config = {
        tables: {
            EVENTS: "Events",
            PERIODS: "Periods",
            PROJECTED_BUDGETS: "ProjectedBudgets",
            EXPENSES: "Expenses",
            EXPENSE_DETAILS: "ExpenseDetails",
            REVENUES: "Revenues",
            REVENUE_DETAILS: "RevenueDetails",
            PERIOD_BUDGET_VERSIONS: "PeriodBudgetVersions",
        },
        triggerColumn: "Duplicate_Trigger",
    };

    let allTables = {};
    let resolvePeriodSelection = null;

    function setUIState(state, message = '') {
        document.getElementById('initial-state').classList.add('hidden');
        document.getElementById('processing-state').classList.add('hidden');
        document.getElementById('period-selector-container').classList.add('hidden');
        document.getElementById('status').textContent = '';

        if (state === 'initial') {
            document.getElementById('initial-state').classList.remove('hidden');
        } else if (state === 'processing') {
            document.getElementById('processing-state').classList.remove('hidden');
            document.getElementById('processing-message').textContent = message;
        } else if (state === 'selecting') {
            document.getElementById('period-selector-container').classList.remove('hidden');
        } else if (['success','error','info'].includes(state)) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status-${state}`;
            document.getElementById('initial-state').classList.remove('hidden');
        }
    }

    async function promptForPeriod(periods) {
        const select = document.getElementById('period-select');
        select.innerHTML = '';
        periods.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.fields.Name;
            select.appendChild(option);
        });
        setUIState('selecting');
        return new Promise(resolve => { resolvePeriodSelection = resolve; });
    }

    document.getElementById('confirm-duplication').addEventListener('click', () => {
        const selected = parseInt(document.getElementById('period-select').value, 10);
        resolvePeriodSelection(selected);
    });
    document.getElementById('cancel-duplication').addEventListener('click', () => {
        resolvePeriodSelection(null);
        setUIState('initial');
    });

    async function duplicateEvent(sourceEvent) {
        if (!sourceEvent) { return; }
        try {
            setUIState('processing', 'Fetching period data...');
            const targetPeriodId = await promptForPeriod(allTables.Periods);
            if (!targetPeriodId) {
                setUIState('info', 'Duplication cancelled.');
                return;
            }

            setUIState('processing', 'Creating new event...');
            const newEventIds = await grist.docApi.addRecords(config.tables.EVENTS, [{
                Name: `${sourceEvent.Name} (Copy)`,
                Sport: sourceEvent.Sport,
                Period: targetPeriodId,
                LocationScope: sourceEvent.LocationScope,
                EventStatus: 1,
                EventType: sourceEvent.EventType,
                DateStart: null,
                DateEnd: null,
                Notes: null,
            }]);
            const newEventId = newEventIds[0];

            // 1. Duplicate PeriodBudgetVersions (only one record)
            setUIState('processing', 'Duplicating budget version...');
            const pbvs = allTables.PeriodBudgetVersions.filter(pb => pb.fields.Event === sourceEvent.id);
            let sourcePBV = pbvs.find(pb => pb.fields.IsActive)
                || pbvs.sort((a, b) => new Date(b.fields.Created) - new Date(a.fields.Created))[0];
            if (sourcePBV) {
                const recordData = {};
                Object.entries(sourcePBV.fields).forEach(([col, val]) => {
                    if (col === 'id' || col === 'Event') { return; }
                    recordData[col] = val;
                });
                recordData.Event = newEventId;
                await grist.docApi.addRecords(config.tables.PERIOD_BUDGET_VERSIONS, [recordData]);
            }

            // 2. Duplicate ProjectedBudgets
            setUIState('processing', 'Duplicating projected budgets...');
            const sourceBuds = allTables.ProjectedBudgets.filter(pb => pb.fields.Event === sourceEvent.id);
            if (sourceBuds.length) {
                await grist.docApi.addRecords(config.tables.PROJECTED_BUDGETS,
                    sourceBuds.map(pb => ({
                        Event: newEventId,
                        Sport: pb.fields.Sport,
                        ProjectedExpenses: pb.fields.ProjectedExpenses,
                        ProjectedRevenues: pb.fields.ProjectedRevenues,
                    }))
                );
            }

            // 3. Duplicate Expenses and Details
            setUIState('processing', 'Duplicating expenses...');
            for (const exp of allTables.Expenses.filter(e => e.fields.Event === sourceEvent.id)) {
                const [newExpId] = await grist.docApi.addRecords(config.tables.EXPENSES, [{
                    Event: newEventId,
                    Category: exp.fields.Category,
                    Budget: exp.fields.Budget,
                    Projected: exp.fields.Projected,
                    Actual: 0,
                    Notes: null,
                }]);
                const details = allTables.ExpenseDetails.filter(d => d.fields.Expense === exp.id);
                if (details.length) {
                    await grist.docApi.addRecords(config.tables.EXPENSE_DETAILS,
                        details.map(d => ({
                            Expense: newExpId,
                            Event: newEventId,
                            Supplier: d.fields.Supplier,
                            Description: d.fields.Description,
                            Budget: d.fields.Budget,
                            Actual: 0,
                            Notes: null,
                        }))
                    );
                }
            }

            // 4. Duplicate Revenues and Details
            setUIState('processing', 'Duplicating revenues...');
            for (const rev of allTables.Revenues.filter(r => r.fields.Event === sourceEvent.id)) {
                const [newRevId] = await grist.docApi.addRecords(config.tables.REVENUES, [{
                    Event: newEventId,
                    Category: rev.fields.Category,
                    Budget: rev.fields.Budget,
                    Projected: rev.fields.Projected,
                    Actual: 0,
                    Notes: null,
                }]);
                const revDetails = allTables.RevenueDetails.filter(d => d.fields.Revenue === rev.id);
                if (revDetails.length) {
                    await grist.docApi.addRecords(config.tables.REVENUE_DETAILS,
                        revDetails.map(d => ({
                            Revenue: newRevId,
                            Event: newEventId,
                            Supplier: d.fields.Supplier,
                            Description: d.fields.Description,
                            Budget: d.fields.Budget,
                            Actual: 0,
                            Notes: null,
                        }))
                    );
                }
            }

            setUIState('success', `Event '${sourceEvent.Name}' duplicated successfully!`);
        }
        catch (err) {
            console.error(err);
            setUIState('error', `Error during duplication: ${err.message}`);
        }
    }

    // Initialize widget
    grist.ready({
        requiredAccess: 'full',
        columns: [config.triggerColumn],
        tables: Object.values(config.tables)
    });

    // Load all tables on startup
    Promise.all([
        grist.docApi.fetchTable(config.tables.EVENTS),
        grist.docApi.fetchTable(config.tables.PERIODS),
        grist.docApi.fetchTable(config.tables.PROJECTED_BUDGETS),
        grist.docApi.fetchTable(config.tables.EXPENSES),
        grist.docApi.fetchTable(config.tables.EXPENSE_DETAILS),
        grist.docApi.fetchTable(config.tables.REVENUES),
        grist.docApi.fetchTable(config.tables.REVENUE_DETAILS),
        grist.docApi.fetchTable(config.tables.PERIOD_BUDGET_VERSIONS),
    ]).then(([evts, pers, pbs, exps, exd, revs, rvd, pbvs]) => {
        allTables = {
            Events: evts,
            Periods: pers,
            ProjectedBudgets: pbs,
            Expenses: exps,
            ExpenseDetails: exd,
            Revenues: revs,
            RevenueDetails: rvd,
            PeriodBudgetVersions: pbvs,
        };
        grist.onRecord(duplicateEvent);
    }).catch(err => {
        console.error(err);
        setUIState('error', 'Failed to load initial data. Check table/column names.');
    });
</script>
</body>
</html>
