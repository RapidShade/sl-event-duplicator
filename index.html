<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Duplicate Event Widget</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        /*
        Basic widget styling:
        - Centered container
        - Simple spinner animation
        - Hidden class toggles visibility
        */
        body {
            font-family: sans-serif;
            padding: 1rem;
            text-align: center;
            color: #333;
            background-color: #f9f9f9;
        }
        #widget-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .hidden { display: none !important; }
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        #period-selector-container {
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: white;
        }
        select,
        button {
            padding: 8px 12px;
            margin-top: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        #status {
            margin-top: 1rem;
            font-weight: bold;
        }
        .status-success { color: green; }
        .status-error   { color: red; }
        .status-info    { color: #555; }
        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="widget-container">

    <!-- Initial idle state -->
    <div id="initial-state">
        <h2>Duplicate Event Widget</h2>
        <p>Click the "Duplicate Event" button in your Events table to begin.</p>
    </div>

    <!-- Processing state: shows spinner + message -->
    <div id="processing-state" class="hidden">
        <div id="loader"></div>
        <p id="processing-message">Working...</p>
    </div>

    <!-- Period selection: dropdown + confirm/cancel -->
    <div id="period-selector-container" class="hidden">
        <label for="period-select">Select Target Period:</label><br>
        <select id="period-select"></select><br>
        <button id="confirm-duplication">Confirm & Duplicate</button>
        <button id="cancel-duplication">Cancel</button>
    </div>

    <!-- Status line for success/error/info -->
    <div id="status"></div>

</div>

<script>
    /**
     * RapidShade Duplicate Event Widget v0.8
     * ---------------------------------------
     * This widget allows admins to clone an existing Event record
     * along with its related records spread across several tables:
     *   - PeriodBudgetVersions
     *   - ProjectedBudgets
     *   - Expenses + ExpenseDetails
     *   - Revenues + RevenueDetails
     *
     * Workflow:
     * 1. User clicks trigger in Events table row
     * 2. Widget prompts for a new Period
     * 3. Creates new Event record
     * 4. Copies PeriodBudgetVersions (active or latest)
     * 5. Copies ProjectedBudgets
     * 6. Copies Expenses + their Details
     * 7. Copies Revenues + their Details
     * 8. Reports success or error
     */

    // Log version for debugging
    console.log("RapidShade: Widget version 0.8");

    // --- CONFIGURATION ---
    // Must match your Grist doc's table names and the trigger column
    const config = {
        tables: {
            EVENTS:               "Events",
            PERIODS:              "Periods",
            PROJECTED_BUDGETS:    "ProjectedBudgets",
            EXPENSES:             "Expenses",
            EXPENSE_DETAILS:      "ExpenseDetails",
            REVENUES:             "Revenues",
            REVENUE_DETAILS:      "RevenueDetails",
            PERIOD_BUDGET_VERSIONS:"PeriodBudgetVersions",
        },
        triggerColumn:          "Duplicate_Trigger",
    };

    // In-memory cache of tables fetched on startup
    let allTables = {};
    // Promise resolver for period selection
    let resolvePeriodSelection = null;

    /**
     * addRecords
     * Uses the TableOperations API to create one record at a time
     * @param {string} table - table name
     * @param {Array<object>} dataArr - array of field:value maps
     * @returns {Promise<Array<number>>} array of new record IDs
     */
        /**
     * addRecords
     * Uses applyUserActions to batch-add records in a single request
     * @param {string} table - table name
     * @param {Array<object>} dataArr - array of field-value maps
     * @returns {Promise<Array<number>>} array of new record IDs
     */
        /**
     * addRecords
     * Uses TableOperations.createRecords to add multiple records at once
     * @param {string} table - table name
     * @param {Array<object>} dataArr - array of field:value maps
     * @returns {Promise<Array<number>>} array of new record IDs
     */
    async function addRecords(table, dataArr) {
        // Get the table operations interface
        const ops = grist.docApi.getTableOperations(table);
        // createRecords expects an object with a `records` property
        const result = await ops.createRecords({ records: dataArr });
        // result is an array of newly created record IDs
        return result;
    }

    /**
     * setUIState
     * Controls which widget section is visible
     */
    function setUIState(state, msg = '') {
        // Hide all
        document.getElementById('initial-state').classList.add('hidden');
        document.getElementById('processing-state').classList.add('hidden');
        document.getElementById('period-selector-container').classList.add('hidden');
        document.getElementById('status').textContent = '';

        // Show relevant
        if (state === 'initial') {
            document.getElementById('initial-state').classList.remove('hidden');
        }
        if (state === 'processing') {
            document.getElementById('processing-state').classList.remove('hidden');
            document.getElementById('processing-message').textContent = msg;
        }
        if (state === 'selecting') {
            document.getElementById('period-selector-container').classList.remove('hidden');
        }
        if (['success','error','info'].includes(state)) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `status-${state}`;
            document.getElementById('initial-state').classList.remove('hidden');
        }
    }

    /**
     * normalizeTableData
     * Converts various fetchTable formats into record array
     */
    function normalizeTableData(tableData) {
        // Already record-array
        if (Array.isArray(tableData)) {
            return tableData;
        }
        // {records: [...]}
        if (tableData.records) {
            return tableData.records;
        }
        // Columnar: each key maps to array
        const keys = Object.keys(tableData).filter(k => Array.isArray(tableData[k]));
        const len  = tableData[keys[0]]?.length || 0;
        const recs = [];
        for (let i = 0; i < len; i++) {
            const rec = {id: null, fields: {}};
            keys.forEach(k => {
                if (k === 'id') rec.id = tableData[k][i];
                else rec.fields[k] = tableData[k][i];
            });
            recs.push(rec);
        }
        return recs;
    }

    /**
     * getPeriodsData
     * Fetches Periods table live for up-to-date choices
     */
    async function getPeriodsData() {
        console.log("RapidShade: Fetching Periods");
        const raw = await grist.docApi.fetchTable(config.tables.PERIODS);
        console.log("RapidShade: Raw periods data:", raw);
        const recs = normalizeTableData(raw);
        console.log("RapidShade: Parsed periods:", recs);
        return recs;
    }

    /**
     * promptForPeriod
     * Shows a dropdown to pick target period
     */
    async function promptForPeriod(periods) {
        if (!Array.isArray(periods) || !periods.length) {
            console.log("RapidShade: No periods available");
            return null;
        }
        const sel = document.getElementById('period-select');
        sel.innerHTML = '';
        periods.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.fields.Name;
            sel.appendChild(opt);
        });
        setUIState('selecting');
        return new Promise(res => resolvePeriodSelection = res);
    }

    // Confirm / Cancel handlers
    document.getElementById('confirm-duplication').addEventListener('click', () => {
        const val = parseInt(document.getElementById('period-select').value, 10);
        console.log(`RapidShade: Period selected ${val}`);
        resolvePeriodSelection(val);
    });
    document.getElementById('cancel-duplication').addEventListener('click', () => {
        console.log("RapidShade: Duplication cancelled by user");
        resolvePeriodSelection(null);
        setUIState('initial');
    });

    /**
     * duplicateEvent
     * Main function invoked per row click
     */
    async function duplicateEvent(sourceEvent) {
        if (!sourceEvent) {
            return;
        }
        console.log(`RapidShade: Initiating duplication for Event ID ${sourceEvent.id}`);
        try {
            // 1) Prompt for Period
            setUIState('processing', 'Loading periods...');
            const periods = await getPeriodsData();
            const targetPeriod = await promptForPeriod(periods);
            if (!targetPeriod) {
                return setUIState('info', 'Duplication canceled.');
            }

            // 2) Create new Event
            setUIState('processing', 'Creating new Event...');
            console.log(`RapidShade: addRecords to Events`);
            const [newE] = await addRecords(config.tables.EVENTS, [{
                Name:           `${sourceEvent.Name} (Copy)`,
                Sport:          sourceEvent.Sport,
                Period:         targetPeriod,
                LocationScope:  sourceEvent.LocationScope,
                EventStatus:    1,
                EventType:      sourceEvent.EventType,
                DateStart:      null,
                DateEnd:        null,
                Notes:          null,
            }]);

            // 3) Copy PeriodBudgetVersions
            setUIState('processing', 'Copying budget version...');
            const versions = allTables.PeriodBudgetVersions.filter(v => v.fields.Event === sourceEvent.id);
            let toCopy = versions.find(v => v.fields.IsActive)
                        || versions.sort((a,b) => new Date(b.fields.Created) - new Date(a.fields.Created))[0];
            if (toCopy) {
                const payload = {};
                Object.entries(toCopy.fields).forEach(([k,v]) => {
                    if (k !== 'id' && k !== 'Event') payload[k] = v;
                });
                payload.Event = newE;
                console.log(`RapidShade: addRecords to PeriodBudgetVersions`);
                await addRecords(config.tables.PERIOD_BUDGET_VERSIONS, [payload]);
            }

            // 4) Copy ProjectedBudgets
            setUIState('processing', 'Copying projected budgets...');
            const pbCopies = allTables.ProjectedBudgets
                .filter(pb => pb.fields.Event === sourceEvent.id)
                .map(pb => ({
                    Event:             newE,
                    Sport:             pb.fields.Sport,
                    ProjectedExpenses: pb.fields.ProjectedExpenses,
                    ProjectedRevenues: pb.fields.ProjectedRevenues,
                }));
            if (pbCopies.length) {
                console.log(`RapidShade: addRecords to ProjectedBudgets [${pbCopies.length}]`);
                await addRecords(config.tables.PROJECTED_BUDGETS, pbCopies);
            }

            // 5) Copy Expenses + ExpenseDetails
            setUIState('processing', 'Copying expenses...');
            for (const exp of allTables.Expenses.filter(e => e.fields.Event === sourceEvent.id)) {
                const [newExp] = await addRecords(config.tables.EXPENSES, [{
                    Event:     newE,
                    Category:  exp.fields.Category,
                    Budget:    exp.fields.Budget,
                    Projected: exp.fields.Projected,
                    Actual:    0,
                    Notes:     null,
                }]);
                console.log(`RapidShade: Created Expense ${newExp}`);

                const details = allTables.ExpenseDetails.filter(d => d.fields.Expense === exp.id)
                    .map(d => ({
                        Expense:    newExp,
                        Event:      newE,
                        Supplier:   d.fields.Supplier,
                        Description:d.fields.Description,
                        Budget:     d.fields.Budget,
                        Actual:     0,
                        Notes:      null,
                    }));
                if (details.length) {
                    console.log(`RapidShade: addRecords to ExpenseDetails [${details.length}]`);
                    await addRecords(config.tables.EXPENSE_DETAILS, details);
                }
            }

            // 6) Copy Revenues + RevenueDetails
            setUIState('processing', 'Copying revenues...');
            for (const rev of allTables.Revenues.filter(r => r.fields.Event === sourceEvent.id)) {
                const [newRev] = await addRecords(config.tables.REVENUES, [{
                    Event:     newE,
                    Category:  rev.fields.Category,
                    Budget:    rev.fields.Budget,
                    Projected: rev.fields.Projected,
                    Actual:    0,
                    Notes:     null,
                }]);
                console.log(`RapidShade: Created Revenue ${newRev}`);

                const revDetails = allTables.RevenueDetails.filter(d => d.fields.Revenue === rev.id)
                    .map(d => ({
                        Revenue:     newRev,
                        Event:       newE,
                        Supplier:    d.fields.Supplier,
                        Description: d.fields.Description,
                        Budget:      d.fields.Budget,
                        Actual:      0,
                        Notes:       null,
                    }));
                if (revDetails.length) {
                    console.log(`RapidShade: addRecords to RevenueDetails [${revDetails.length}]`);
                    await addRecords(config.tables.REVENUE_DETAILS, revDetails);
                }
            }

            // Final success
            setUIState('success', `Event '${sourceEvent.Name}' duplicated successfully!`);
            console.log('RapidShade: Duplication completed');
        }
        catch (err) {
            console.error('RapidShade: Duplication error', err);
            setUIState('error', `Error: ${err.message}`);
        }
    }

    // --- INITIALIZATION ---
    // Tell Grist our requirements and fetch static tables
    grist.ready({
        requiredAccess: 'full',
        columns:       [config.triggerColumn],
        tables:        Object.values(config.tables)
    });

    // Preload all static tables to memory
    Promise.all([
        grist.docApi.fetchTable(config.tables.EVENTS),
        grist.docApi.fetchTable(config.tables.PERIOD_BUDGET_VERSIONS),
        grist.docApi.fetchTable(config.tables.PROJECTED_BUDGETS),
        grist.docApi.fetchTable(config.tables.EXPENSES),
        grist.docApi.fetchTable(config.tables.EXPENSE_DETAILS),
        grist.docApi.fetchTable(config.tables.REVENUES),
        grist.docApi.fetchTable(config.tables.REVENUE_DETAILS),
    ]).then(([events, pbv, pjb, exp, exd, rev, rvd]) => {
        allTables = {
            Events:                 normalizeTableData(events),
            PeriodBudgetVersions:   normalizeTableData(pbv),
            ProjectedBudgets:       normalizeTableData(pjb),
            Expenses:               normalizeTableData(exp),
            ExpenseDetails:         normalizeTableData(exd),
            Revenues:               normalizeTableData(rev),
            RevenueDetails:         normalizeTableData(rvd),
        };
        console.log('RapidShade: Static tables loaded');
        // Register handler for row clicks
        grist.onRecord(duplicateEvent);
    }).catch(err => {
        console.error('RapidShade: Initialization error', err);
        setUIState('error', 'Initialization failed. Check table/column names.');
    });

</script>
</body>
</html>
